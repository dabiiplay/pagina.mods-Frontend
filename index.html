<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página Mods</title>
    <link rel="icon" href="./cat.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            overflow: hidden;
            background-color: #1a202c;
        }
        .element-wrapper {
            position: absolute;
            cursor: grab;
            user-select: none;
            box-sizing: border-box;
            transition: box-shadow 0.1s ease-in-out;
            will-change: transform, left, top;
        }
        .element-wrapper.selected {
            box-shadow: 0 0 0 2px #8B5CF6;
            cursor: grabbing;
        }
        .text-element-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .element-content {
            display: block;
            object-fit: contain;
            width: 100%;
            height: 100%;
        }
        .audio-visual-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            pointer-events: none;
        }
        .text-content {
            white-space: pre-wrap;
            word-break: break-word;
            text-align: center;
            box-sizing: border-box;
            line-height: 1;
            padding: 0px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #8B5CF6;
            border: 1px solid #ffffff;
            cursor: grab;
            z-index: 1000;
        }
        .resize-handle.top-left { top: -5px; left: -5px; cursor: nwse-resize; }
        .resize-handle.top-right { top: -5px; right: -5px; cursor: nesw-resize; }
        .resize-handle.bottom-left { bottom: -5px; left: -5px; cursor: nesw-resize; }
        .resize-handle.bottom-right { bottom: -5px; right: -5px; cursor: nwse-resize; }
        .rotation-handle {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background-color: #8B5CF6;
            border-radius: 50%;
            border: 1px solid #ffffff;
            cursor: grab;
            z-index: 1000;
            display: none;
        }
        .sidebar-scroll {
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .sidebar-scroll::-webkit-scrollbar {
            display: none;
        }
        .tab-button {
            padding: 0.35rem 1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #A0AEC0;
            transition: all 0.2s ease-in-out;
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .tab-button.active {
            border-bottom-color: transparent;
            background-color: #4A5568;
            color: #FFFFFF;
        }
        .tab-content {
            display: none;
            padding-top: 0.5rem;
        }
        .tab-content.active {
            display: block;
        }
        .layer-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: #2D3748;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            color: #E2E8F0;
        }
        .layer-item:hover {
            background-color: #4A5568;
        }
        .layer-item.selected {
            background-color: #8B5CF6;
            color: #FFFFFF;
        }
        button.active-style {
            background-color: #8B5CF6;
            border: 1px solid #7C3AED;
        }
        .reset-button {
            background: none;
            border: none;
            cursor: pointer;
            color: #A0AEC0;
            padding: 0.25rem;
            line-height: 1;
        }
        .reset-button:hover {
            color: #E2E8F0;
        }
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: transparent;
            border: none;
            cursor: pointer;
            width: 100%;
            height: 2.5rem;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
        }
        input[type="color"]::-moz-color-remap-panel {
            border: none;
        }
        input[type="color"]::-moz-color-swatch {
        }
        .custom-file-input {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        .custom-file-input input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            aside {
                width: 100%;
                height: auto;
                max-height: 50vh;
            }
            main {
                flex-grow: 1;
                width: 100%;
                margin: 0.5rem;
            }
        }
        input[type="range"].w-full {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            width: 100%;
            height: 8px;
        }
        input[type="range"].w-full::-webkit-slider-runnable-track {
            background: #4A5568;
            border-radius: 4px;
            height: 4px;
        }
        input[type="range"].w-full::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background-color: #8B5CF6;
            border: 1px solid #FFFFFF;
            border-radius: 50%;
            height: 16px;
            width: 16px;
            margin-top: -6px;
        }
        input[type="range"].w-full::-moz-range-track {
            background: #4A5568;
            border-radius: 4px;
            height: 4px;
        }
        input[type="range"].w-full::-moz-range-thumb {
            background-color: #8B5CF6;
            border: 1px solid #FFFFFF;
            border-radius: 50%;
            height: 16px;
            width: 16px;
        }
        main#editorCanvas {
            position: relative;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1rem;
            overflow: hidden;
        }
        #mainCanvasWrapper {
            display: flex;
            position: relative;
            width: 1496px;
            height: 720px;
            transform-origin: center center;
            flex-shrink: 0;
        }
        #leftSidebar {
            width: 200px;
            height: 720px;
            background-color: rgba(16, 185, 129, 0.5);
            border: 2px dashed #4ade80;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        #innerCanvas {
            width: 1280px;
            height: 720px;
            background-color: transparent;
            border: 2px dashed white;
            flex-shrink: 0;
        }
        #dropArea {
            border: 2px dashed #4A5568;
            background-color: #2D3748;
            text-align: center;
            padding: 1rem;
            margin-top: 1rem;
            color: #A0AEC0;
            font-size: 0.875rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        #dropArea.highlight {
            background-color: #4A5568;
            border-color: #8B5CF6;
        }
        #newZoomRange::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background-color: #8B5CF6;
            border: 1px solid #FFFFFF;
            border-radius: 50%;
            height: 16px;
            width: 16px;
            margin-top: -5px;
        }
        #newZoomRange::-moz-range-thumb {
            background-color: #8B5CF6;
            border: 1px solid #FFFFFF;
            border-radius: 50%;
            height: 16px;
            width: 16px;
            margin-top: -5px;
        }
        #loadingSpinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 0.75rem;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.125rem;
            font-weight: 600;
        }
        #loadingSpinner.hidden {
            display: none;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #8B5CF6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #wsStatus {
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            text-align: center;
        }
        #wsStatus.connected {
            background-color: #10B981;
            color: #064E40;
        }
        #wsStatus.disconnected {
            background-color: #EF4444;
            color: #7F1D1D;
        }
        #wsStatus.connecting {
            background-color: #FBBF24;
            color: #78350F;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-dialog {
            background-color: #2D3748;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            width: 400px;
            text-align: center;
            color: #E2E8F0;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.active .modal-dialog {
            transform: translateY(0);
        }
        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #8B5CF6;
        }
        .modal-message {
            font-size: 1rem;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        .modal-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .modal-button:hover {
            transform: translateY(-2px);
        }
        .modal-button.mute {
            background-color: #EF4444;
            color: #FFFFFF;
            border: 1px solid #DC2626;
        }
        .modal-button.mute:hover {
            background-color: #DC2626;
        }
        .modal-button.sound {
            background-color: #10B981;
            color: #FFFFFF;
            border: 1px solid #059669;
        }
        .modal-button.sound:hover {
            background-color: #059669;
        }
    </style>
</head>
<body class="h-screen flex text-gray-800">
    <div id="loadingSpinner" class="hidden">
        <div class="spinner"></div>
        Cargando elementos...
    </div>
    <div id="mutePreferenceModal" class="modal-overlay">
        <div class="modal-dialog">
            <h3 class="modal-title">¡Atención!</h3>
            <p class="modal-message">
                Se recomienda silenciar la página para evitar interrupciones.
            </p>
            <div class="modal-buttons">
                <button id="modalMuteBtn" class="modal-button mute">Silenciar</button>
                <button id="modalSoundBtn" class="modal-button sound">Con Sonido</button>
            </div>
        </div>
    </div>
    <aside class="w-80 bg-gray-900 shadow-lg flex flex-col sidebar-scroll text-gray-200 md:w-80 pt-4 z-20">
        <div class="border-b pb-2 border-gray-700 px-4">
            <label for="imageUpload" class="block text-sm font-medium text-gray-300 mb-2 text-center">Subir Imagen/GIF/MP3</label>
            <div class="custom-file-input w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 cursor-pointer transition-colors duration-200 text-center">
                <span id="selectFileButtonText">Seleccionar archivo</span>
                <input type="file" id="imageUpload" accept="image/*, .gif, audio/mpeg" class="block w-full text-sm text-gray-400">
            </div>
            <span id="fileCountDisplay" class="block text-xs text-gray-400 mt-2 text-center">0/50</span>
            <div id="dropArea">Arrastra y suelta archivos aquí</div>
            <div id="wsStatus" class="disconnected">Desconectado</div>
        </div>
        <div class="flex border-b border-gray-700">
            <button class="tab-button active flex-1 text-center" data-tab="properties">Ajustes</button>
            <button class="tab-button flex-1 text-center" data-tab="text">Texto</button>
            <button class="tab-button flex-1 text-center" data-tab="audio">Audio</button>
            <button class="tab-button flex-1 text-center" data-tab="layers">Capas</button>
        </div>
        <div id="tab-content-properties" class="tab-content active flex-grow px-4">
            <h2 class="text-lg font-semibold mb-4 text-purple-400">Controles de Elemento</h2>
            <div class="mb-4">
                <label for="opacityRange" class="block text-sm font-medium text-gray-300 mb-2">Opacidad</label>
                <div class="flex items-center space-x-2">
                    <input type="range" id="opacityRange" min="0" max="1" step="0.01" value="1" disabled class="w-full h-2 bg-gray-700 appearance-none cursor-pointer range-shadow">
                    <span id="opacityValue" class="text-xs text-gray-400 w-10 text-right">100%</span>
                    <button id="resetOpacityBtn" class="reset-button" title="Reiniciar Opacidad" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="mb-6">
                <label for="rotationRange" class="block text-sm font-medium text-gray-300 mb-2">Rotación</label>
                <div class="flex items-center space-x-2">
                    <input type="range" id="rotationRange" min="0" max="360" step="1" value="0" disabled class="w-full h-2 bg-gray-700 appearance-none cursor-pointer range-shadow">
                    <span id="rotationValue" class="text-xs text-gray-400 w-10 text-right">0°</span>
                    <button id="resetRotationBtn" class="reset-button" title="Reiniciar Rotación" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <button id="duplicateElementBtn" disabled class="w-full bg-purple-700 hover:bg-purple-800 text-white font-bold py-2 px-4 shadow-md transition-all duration-200 mb-3 disabled:opacity-50 disabled:cursor-not-allowed">
                Duplicar elemento
            </button>
            <button id="bringToFrontBtn" disabled class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 shadow-md transition-all duration-200 mb-3 disabled:opacity-50 disabled:cursor-not-allowed">
                Traer al frente
            </button>
            <button id="deleteElementBtn" disabled class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 shadow-md transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed mb-4">
                Eliminar elemento
            </button>
        </div>
        <div id="tab-content-text" class="tab-content flex-grow px-4">
            <label for="textInput" class="block text-sm font-medium text-gray-300 mb-2">Contenido del Texto</label>
            <textarea id="textInput" class="w-full p-2 border border-gray-600 bg-gray-700 text-gray-100 focus:outline-none focus:ring-purple-400" rows="3" placeholder="Escribe aquí el texto"></textarea>
            <button id="addTextBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 shadow-md transition-all duration-200 mb-4">
                Añadir Texto al Lienzo
            </button>
            <h3 class="text-md font-semibold mb-2 text-purple-400 mt-6">Ajustes de Estilo de Texto</h3>
            <div class="flex space-x-2 mb-4">
                <button id="boldTextBtn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 shadow-md transition-all duration-200">
                    Negrita
                </button>
                <button id="italicTextBtn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white italic py-2 px-4 shadow-md transition-all duration-200">
                    Cursiva
                </button>
            </div>
            <div class="mb-4">
                <label for="fontSizeRange" class="block text-sm font-medium text-gray-300 mb-2">Tamaño del Texto</label>
                <div class="flex items-center space-x-2">
                    <input type="range" id="fontSizeRange" min="10" max="100" step="1" value="24" class="w-full h-2 bg-gray-700 appearance-none cursor-pointer range-shadow">
                    <span id="fontSizeValue" class="text-xs text-gray-400 w-10 text-right">24px</span>
                </div>
            </div>
            <div class="mb-4">
                <label for="textColor" class="block text-sm font-medium text-gray-300 mb-2">Color del Texto</label>
                <input type="color" id="textColor" value="#FFFFFF" class="w-full h-8 border border-gray-600 bg-gray-700 p-1 cursor-pointer">
            </div>
            <div class="mb-4">
                <div class="flex items-center justify-between space-x-2">
                    <label for="toggleTextBg" class="text-sm font-medium text-gray-300 cursor-pointer">Fondo del Texto</label>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="toggleTextBg" class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 focus:ring-purple-500">
                        <label for="toggleTextBg" class="text-sm font-medium text-gray-300 cursor-pointer">Activar</label>
                    </div>
                </div>
                <div class="pl-4 border-l border-gray-700 mt-2">
                    <label id="textBgColorLabel" for="textBgColor" class="block text-sm font-medium text-gray-400 mb-2 mt-2 disabled:text-gray-600">Color de Fondo del Texto</label>
                    <input type="color" id="textBgColor" value="#000000" class="w-full h-8 border border-gray-600 bg-gray-700 p-1 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-800">
                </div>
            </div>
            <div class="mb-4">
                <div class="flex items-center justify-between space-x-2">
                    <label for="toggleTextOutline" class="text-sm font-medium text-gray-300 cursor-pointer">Contorno del Texto</label>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="toggleTextOutline" class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 focus:ring-purple-500">
                        <label for="toggleTextOutline" class="text-sm font-medium text-gray-300 cursor-pointer">Activar</label>
                    </div>
                </div>
                <div class="pl-4 border-l border-gray-700 mt-2">
                    <label id="textOutlineColorLabel" for="textOutlineColor" class="block text-sm font-medium text-gray-400 mb-2 mt-2 disabled:text-gray-600">Color del Contorno</label>
                    <input type="color" id="textOutlineColor" value="#000000" class="w-full h-8 border border-gray-600 bg-gray-700 p-1 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-800">
                    <label id="outlineThicknessLabel" for="outlineThicknessRange" class="block text-sm font-medium text-gray-400 mb-2 mt-4 disabled:text-gray-600">Grosor del Contorno</label>
                    <div class="flex items-center space-x-2">
                        <input type="range" id="outlineThicknessRange" min="0" max="5" step="0.1" value="0" disabled class="w-full h-2 bg-gray-700 appearance-none cursor-pointer range-shadow">
                        <span id="outlineThicknessValue" class="text-xs text-gray-400 w-10 text-right">0px</span>
                    </div>
                </div>
            </div>
        </div>
        <div id="tab-content-audio" class="tab-content flex-grow px-4">
            <h2 class="text-lg font-semibold mb-4 text-purple-400">Controles de Audio</h2>
            <span id="currentAudioName" class="block text-sm text-gray-400 mb-2"></span>
            <div class="flex items-center justify-center space-x-4 mb-4">
                <button id="playPauseBtn" disabled class="bg-purple-600 hover:bg-purple-700 text-white font-bold p-3 rounded-full shadow-md transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.38 2.872-1.667l11.553 6.917c1.164.696 1.164 2.67 0 3.366l-11.553 6.917C6.029 21.38 4.5 20.426 4.5 19.0V5.653Z" clip-rule="evenodd" />
                    </svg>
                    <svg id="pauseIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 hidden">
                        <path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 0 1 .75-.75H9a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H7.5a.75.75 0 0 1-.75-.75V5.25ZM14.25 5.25a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75h-1.5a.75.75 0 0 1-.75-.75V5.25Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div class="mb-4">
                <label for="volumeRange" class="block text-sm font-medium text-gray-300 mb-2">Volumen</label>
                <div class="flex items-center space-x-2">
                    <input type="range" id="volumeRange" min="0" max="1" step="0.01" value="0.5" disabled class="w-full h-2 bg-gray-700 appearance-none cursor-pointer range-shadow">
                    <span id="volumeValue" class="text-xs text-gray-400 w-10 text-right">50%</span>
                </div>
            </div>
            <div class="mb-4">
                <label for="timelineRange" class="block text-sm font-medium text-gray-300 mb-2">Línea de tiempo</label>
                <div class="flex items-center space-x-2">
                    <input type="range" id="timelineRange" min="0" max="100" step="0.1" value="0" disabled class="w-full h-2 bg-gray-700 appearance-none cursor-pointer range-shadow">
                    <span id="currentTimeDisplay" class="text-xs text-gray-400 w-16 text-right">0:00 / 0:00</span>
                </div>
            </div>
        </div>
        <div id="tab-content-layers" class="tab-content flex-grow px-4">
            <h2 class="text-lg font-semibold mb-4 text-purple-400">Capas de Elementos</h2>
            <div id="layersList" class="space-y-2">
                <p class="text-gray-400 text-sm">No hay elementos en la página.</p>
            </div>
        </div>
    </aside>
    <main id="editorCanvas" class="relative m-4 shadow-inner">
        <div id="mainCanvasWrapper">
            <div id="leftSidebar"></div>
            <div id="innerCanvas">
            </div>
        </div>
    </main>
    <div class="absolute bottom-4 right-4 bg-gray-800 p-2 rounded-lg shadow-xl z-50 flex items-center space-x-2 zoom-controls">
        <label for="newZoomRange" class="text-sm font-medium text-gray-300">Zoom</label>
        <input type="range" id="newZoomRange" min="0.25" max="2.0" step="0.05" value="1.0" class="w-24 h-2 bg-gray-700 appearance-none cursor-pointer">
        <span id="zoomValue" class="text-xs text-gray-400">100%</span>
    </div>
    <script>
        const editorCanvas = document.getElementById('editorCanvas');
        const mainCanvasWrapper = document.getElementById('mainCanvasWrapper');
        const leftSidebar = document.getElementById('leftSidebar');
        const innerCanvas = document.getElementById('innerCanvas');
        const sidebar = document.querySelector('aside');
        const imageUpload = document.getElementById('imageUpload');
        const addTextBtn = document.getElementById('addTextBtn');
        const textInput = document.getElementById('textInput');
        const opacityRange = document.getElementById('opacityRange');
        const opacityValue = document.getElementById('opacityValue');
        const rotationRange = document.getElementById('rotationRange');
        const rotationValue = document.getElementById('rotationValue');
        const duplicateElementBtn = document.getElementById('duplicateElementBtn');
        const deleteElementBtn = document.getElementById('deleteElementBtn');
        const layersList = document.getElementById('layersList');
        const bringToFrontBtn = document.getElementById('bringToFrontBtn');
        const textColorInput = document.getElementById('textColor');
        const textBgColorInput = document.getElementById('textBgColor');
        const boldTextBtn = document.getElementById('boldTextBtn');
        const italicTextBtn = document.getElementById('italicTextBtn');
        const toggleTextBg = document.getElementById('toggleTextBg');
        const toggleTextOutline = document.getElementById('toggleTextOutline');
        const textOutlineColorInput = document.getElementById('textOutlineColor');
        const outlineThicknessRange = document.getElementById('outlineThicknessRange');
        const outlineThicknessValue = document.getElementById('outlineThicknessValue');
        const fontSizeRange = document.getElementById('fontSizeRange');
        const fontSizeValue = document.getElementById('fontSizeValue');
        const resetOpacityBtn = document.getElementById('resetOpacityBtn');
        const resetRotationBtn = document.getElementById('resetRotationBtn');
        const audioControlsSection = document.getElementById('tab-content-audio');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const volumeRange = document.getElementById('volumeRange');
        const volumeValueDisplay = document.getElementById('volumeValue');
        const timelineRange = document.getElementById('timelineRange');
        const currentTimeDisplay = document.getElementById('currentTimeDisplay');
        const currentAudioNameDisplay = document.getElementById('currentAudioName');
        const fileLimit = 50;
        const fileCountDisplay = document.getElementById('fileCountDisplay');
        const selectFileButtonText = document.getElementById('selectFileButtonText');
        const textBgColorLabel = document.getElementById('textBgColorLabel');
        const textOutlineColorLabel = document.getElementById('textOutlineColorLabel');
        const outlineThicknessLabel = document.getElementById('outlineThicknessLabel');
        const zoomRange = document.getElementById('newZoomRange');
        const zoomValue = document.getElementById('zoomValue');
        const dropArea = document.getElementById('dropArea');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const wsStatusElement = document.getElementById('wsStatus');
        const mutePreferenceModal = document.getElementById('mutePreferenceModal');
        const modalMuteBtn = document.getElementById('modalMuteBtn');
        const modalSoundBtn = document.getElementById('modalSoundBtn');
        let selectedElementWrapper = null;
        let isDragging = false;
        let isResizing = false;
        let isRotating = false;
        let activeHandle = '';
        let initialMouseX, initialMouseY;
        let initialLeft, initialTop, initialWidth, initialHeight;
        let initialRotationAngle = 0;
        let initialElementRotation = 0;
        let currentZoom = 1.0;
        let isMutedGlobally = true;
        const allElements = new Map();
        const WS_URL = 'wss://pagina-mods-websocket-server.onrender.com';
        let ws;
        let reconnectInterval;
        let pendingUpdateAnimationFrame = null; // Variable para controlar el requestAnimationFrame de las actualizaciones

        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log('WebSocket ya conectado.');
                return;
            }
            updateWsStatus('connecting');
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('Conectado al servidor WebSocket');
                updateWsStatus('connected');
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'initialState') {
                    allElements.clear();
                    mainCanvasWrapper.querySelectorAll('.element-wrapper').forEach(el => el.remove());
                    message.elements.forEach(data => {
                        createElementFromData(data);
                    });
                    updateLayersList();
                    updateFileCountDisplay();
                    deselectAllElements();
                } else if (message.type === 'elementAdd') {
                    createElementFromData(message.element);
                    updateLayersList();
                } else if (message.type === 'elementUpdate') {
                    updateElementFromData(message.element);
                    updateLayersList();
                } else if (message.type === 'elementDelete') {
                    deleteElementFromData(message.elementId);
                    updateLayersList();
                    updateFileCountDisplay();
                } else if (message.type === 'reorderLayers') {
                    message.elements.forEach(elementData => {
                        const elementWrapper = allElements.get(elementData.id);
                        if (elementWrapper) {
                            elementWrapper.style.zIndex = elementData.zIndex;
                        }
                    });
                    updateLayersList();
                } else if (message.type === 'ping') {
                    // console.log('Ping received');
                }
            };

            ws.onclose = () => {
                console.log('Desconectado del servidor WebSocket. Intentando reconectar...');
                updateWsStatus('disconnected');
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 5000);
                }
            };

            ws.onerror = (err) => {
                console.error('Error de WebSocket:', err);
                ws.close();
            };
        }

        function sendWebSocketMessage(type, data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type, ...data }));
            } else {
                console.warn('WebSocket no conectado, no se pudo enviar el mensaje:', type, data);
            }
        }

        function updateWsStatus(status) {
            wsStatusElement.classList.remove('connected', 'disconnected', 'connecting');
            if (status === 'connected') {
                wsStatusElement.classList.add('connected');
                wsStatusElement.textContent = 'Conectado';
            } else if (status === 'disconnected') {
                wsStatusElement.classList.add('disconnected');
                wsStatusElement.textContent = 'Desconectado';
            } else if (status === 'connecting') {
                wsStatusElement.classList.add('connecting');
                wsStatusElement.textContent = 'Conectando...';
            }
        }

        function generateUniqueId() {
            return 'element-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        function getNextHighestZIndex() {
            let maxZ = 0;
            mainCanvasWrapper.querySelectorAll('.element-wrapper').forEach(elementWrapper => {
                const currentZ = parseInt(elementWrapper.style.zIndex || 0);
                if (currentZ > maxZ) {
                    maxZ = currentZ;
                }
            });
            return maxZ + 1;
        }

        function applyZoom() {
            mainCanvasWrapper.style.transform = `scale(${currentZoom})`;
            mainCanvasWrapper.style.transformOrigin = 'center center';
            zoomValue.textContent = `${Math.round(currentZoom * 100)}%`;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        function generateTextShadowForOutline(thickness, color) {
            if (parseFloat(thickness) === 0) return 'none';
            const t = parseFloat(thickness);
            let shadow = [];
            shadow.push(`${-t}px ${-t}px 0 ${color}`);
            shadow.push(`${0}px ${-t}px 0 ${color}`);
            shadow.push(`${t}px ${-t}px 0 ${color}`);
            shadow.push(`${-t}px ${0}px 0 ${color}`);
            shadow.push(`${t}px ${0}px 0 ${color}`);
            shadow.push(`${-t}px ${t}px 0 ${color}`);
            shadow.push(`${0}px ${t}px 0 ${color}`);
            shadow.push(`${t}px ${t}px 0 ${color}`);
            return shadow.join(', ');
        }

        function adjustTextElementWrapperSize(elementWrapper) {
            const textElement = elementWrapper.querySelector('.element-content');
            if (!textElement) return;

            const computedStyle = window.getComputedStyle(textElement);
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.visibility = 'hidden';
            tempDiv.style.left = '-9999px';
            tempDiv.style.top = '-9999px';
            tempDiv.style.height = 'auto';
            tempDiv.style.width = 'auto';
            tempDiv.style.whiteSpace = 'pre-wrap';
            tempDiv.style.wordBreak = 'break-word';
            tempDiv.style.boxSizing = 'border-box';
            tempDiv.style.lineHeight = '1';
            tempDiv.style.textAlign = 'center';
            tempDiv.style.display = 'flex';
            tempDiv.style.alignItems = 'center';
            tempDiv.style.justifyContent = 'center';

            tempDiv.style.fontSize = computedStyle.fontSize;
            tempDiv.style.fontWeight = computedStyle.fontWeight;
            tempDiv.style.fontStyle = computedStyle.fontStyle;
            tempDiv.style.fontFamily = computedStyle.fontFamily;
            tempDiv.style.color = computedStyle.color;
            tempDiv.style.backgroundColor = computedStyle.backgroundColor;

            const outlineThickness = parseFloat(textElement.style.webkitTextStrokeWidth) || 0;
            const outlineColor = textElement.style.webkitTextStrokeColor || '#000000';
            if (outlineThickness > 0) {
                tempDiv.style.webkitTextStrokeWidth = `${outlineThickness}px`;
                tempDiv.style.webkitTextStrokeColor = outlineColor;
                tempDiv.style.textShadow = generateTextShadowForOutline(outlineThickness, outlineColor);
            } else {
                tempDiv.style.webkitTextStrokeWidth = '0';
                tempDiv.style.webkitTextStrokeColor = 'transparent';
                tempDiv.style.textShadow = 'none';
            }

            tempDiv.textContent = textElement.textContent;
            document.body.appendChild(tempDiv);

            const rawTextRect = tempDiv.getBoundingClientRect();
            const rawContentWidth = rawTextRect.width;
            const rawContentHeight = rawTextRect.height;

            document.body.removeChild(tempDiv);

            const wrapperPaddingHorizontal = 25;
            const wrapperPaddingVertical = 10;

            elementWrapper.style.width = `${rawContentWidth + (wrapperPaddingHorizontal * 2)}px`;
            elementWrapper.style.height = `${rawContentHeight + (wrapperPaddingVertical * 2)}px`;
            elementWrapper.style.padding = `${wrapperPaddingVertical}px ${wrapperPaddingHorizontal}px`;
            textElement.style.padding = '0px';
        }

        function saveElementsState() {
            localStorage.setItem('isMutedGlobally', JSON.stringify(isMutedGlobally));
        }

        function loadElementsState() {
            const storedMuteState = localStorage.getItem('isMutedGlobally');
            if (storedMuteState !== null) {
                isMutedGlobally = JSON.parse(storedMuteState);
            } else {
                isMutedGlobally = true;
            }
        }

        function createElementFromData(data) {
            if (allElements.has(data.id)) {
                updateElementFromData(data);
                return;
            }

            const wrapperDiv = document.createElement('div');
            wrapperDiv.id = data.id;
            wrapperDiv.classList.add('element-wrapper');
            if (data.type === 'text') {
                wrapperDiv.classList.add('text-element-wrapper');
            }

            wrapperDiv.style.left = data.left;
            wrapperDiv.style.top = data.top;
            wrapperDiv.style.width = data.width;
            wrapperDiv.style.height = data.height;
            wrapperDiv.style.transform = data.rotation;
            wrapperDiv.style.zIndex = data.zIndex;
            if (data.originalName) {
                wrapperDiv.dataset.originalName = data.originalName;
            }

            let contentElement;
            if (data.type === 'img') {
                contentElement = document.createElement('img');
                contentElement.src = data.src;
                contentElement.alt = data.originalName || 'Image';
                contentElement.classList.add('element-content');
            } else if (data.type === 'audio') {
                contentElement = document.createElement('audio');
                contentElement.src = data.src;
                contentElement.volume = data.volume || 0.5;
                contentElement.currentTime = data.currentTime || 0;
                contentElement.dataset.lastVolume = data.lastVolume || 0.5;
                contentElement.muted = data.muted || isMutedGlobally;
                contentElement.classList.add('element-content');
                contentElement.classList.add('hidden');

                contentElement.addEventListener('loadedmetadata', () => {
                    if (isNaN(contentElement.duration)) {
                        contentElement.duration = data.duration || contentElement.duration;
                    }
                    updateTimelineDisplay(contentElement);
                });
                contentElement.addEventListener('timeupdate', () => {
                    if (selectedElementWrapper && selectedElementWrapper.id === wrapperDiv.id) {
                        updateTimelineDisplay(contentElement);
                    }
                });
                contentElement.addEventListener('ended', () => {
                    if (selectedElementWrapper && selectedElementWrapper.id === wrapperDiv.id) {
                        updatePlayPauseButton(true);
                        contentElement.currentTime = 0;
                        timelineRange.value = 0;
                        currentTimeDisplay.textContent = formatTime(0) + ' / ' + formatTime(contentElement.duration || 0);
                    }
                });

                const audioIcon = document.createElement('div');
                audioIcon.classList.add('audio-visual-icon', 'flex', 'items-center', 'justify-center', 'text-gray-400', 'text-2xl', 'h-full', 'w-full');
                audioIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
                        <path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 10v4h3l4 4V6l-4 4H5z"/>
                    </svg>
                `;
                wrapperDiv.appendChild(audioIcon);
                wrapperDiv.appendChild(contentElement);
            } else if (data.type === 'text') {
                contentElement = document.createElement('div');
                contentElement.classList.add('text-content');
                contentElement.classList.add('element-content');
                contentElement.contentEditable = true;
                contentElement.textContent = data.textContent;
                contentElement.style.color = data.color;
                contentElement.style.backgroundColor = data.backgroundColor;
                contentElement.style.fontSize = data.fontSize;
                contentElement.spellcheck = false;

                if (data.isBold) contentElement.classList.add('font-bold');
                if (data.isItalic) contentElement.classList.add('italic');

                if (data.hasTextOutline && parseFloat(data.outlineThickness) > 0) {
                    contentElement.style.webkitTextStrokeWidth = data.outlineThickness;
                    contentElement.style.webkitTextStrokeColor = data.outlineColor;
                    contentElement.style.textShadow = generateTextShadowForOutline(parseFloat(data.outlineThickness), data.outlineColor);
                } else {
                    contentElement.style.webkitTextStrokeWidth = '0';
                    contentElement.style.webkitTextStrokeColor = 'transparent';
                    contentElement.style.textShadow = 'none';
                }
            } else {
                console.warn('Unknown element type in saved data (only image/text/audio expected):', data.type);
                return;
            }

            contentElement.style.opacity = data.opacity;
            if (data.type !== 'audio') {
                 wrapperDiv.appendChild(contentElement);
            }
            addHandles(wrapperDiv);
            mainCanvasWrapper.appendChild(wrapperDiv);
            allElements.set(wrapperDiv.id, wrapperDiv);

            if (data.type === 'text') {
                adjustTextElementWrapperSize(wrapperDiv);
            }

            if (data.type === 'audio' && data.isPlaying && !isMutedGlobally) {
                contentElement.play().catch(e => {
                    console.warn('Autoplay blocked for loaded audio on page load:', e);
                });
            }
        }

        function updateElementFromData(data) {
            const elementWrapper = allElements.get(data.id);
            if (!elementWrapper) {
                createElementFromData(data);
                return;
            }

            elementWrapper.style.left = data.left;
            elementWrapper.style.top = data.top;
            elementWrapper.style.width = data.width;
            elementWrapper.style.height = data.height;
            elementWrapper.style.transform = data.rotation;
            elementWrapper.style.zIndex = data.zIndex;
            elementWrapper.dataset.originalName = data.originalName || '';

            const contentElement = elementWrapper.querySelector('img.element-content, audio.element-content, div.text-content.element-content');
            if (!contentElement) {
                console.error(`Content element not found inside wrapper ${data.id} for update.`);
                return;
            }

            contentElement.style.opacity = data.opacity;

            if (data.type === 'img') {
                // No specific image updates needed beyond common properties
            } else if (data.type === 'audio') {
                if (contentElement.src !== data.src) {
                    contentElement.src = data.src;
                    contentElement.load();
                }
                contentElement.volume = data.volume;
                contentElement.dataset.lastVolume = data.lastVolume;
                contentElement.muted = data.muted || isMutedGlobally;

                // Solo actualizar currentTime si el audio está en pausa o la diferencia es significativa
                if (contentElement.paused || Math.abs(contentElement.currentTime - data.currentTime) > 0.1) {
                    contentElement.currentTime = data.currentTime;
                }

                if (data.isPlaying && contentElement.paused && !isMutedGlobally) {
                    contentElement.play().catch(e => console.warn('Autoplay blocked during update:', e));
                } else if (!data.isPlaying && !contentElement.paused) {
                    contentElement.pause();
                }

                if (selectedElementWrapper && selectedElementWrapper.id === data.id) {
                    volumeRange.value = contentElement.volume;
                    volumeValueDisplay.textContent = `${Math.round(contentElement.volume * 100)}%`;
                    updatePlayPauseButton(contentElement.paused);
                    updateTimelineDisplay(contentElement);
                    currentAudioNameDisplay.textContent = data.originalName || 'Audio Seleccionado';
                }
            } else if (data.type === 'text') {
                contentElement.textContent = data.textContent;
                contentElement.style.color = data.color;
                contentElement.style.backgroundColor = data.backgroundColor;
                contentElement.style.fontSize = data.fontSize;

                if (data.isBold) contentElement.classList.add('font-bold');
                else contentElement.classList.remove('font-bold');

                if (data.isItalic) contentElement.classList.add('italic');
                else contentElement.classList.remove('italic');

                if (data.hasTextOutline && parseFloat(data.outlineThickness) > 0) {
                    contentElement.style.webkitTextStrokeWidth = data.outlineThickness;
                    contentElement.style.webkitTextStrokeColor = data.outlineColor;
                    contentElement.style.textShadow = generateTextShadowForOutline(parseFloat(data.outlineThickness), data.outlineColor);
                } else {
                    contentElement.style.webkitTextStrokeWidth = '0';
                    contentElement.style.webkitTextStrokeColor = 'transparent';
                    contentElement.style.textShadow = 'none';
                }
                adjustTextElementWrapperSize(elementWrapper);

                if (selectedElementWrapper && selectedElementWrapper.id === data.id) {
                    textInput.value = data.textContent;
                    textColorInput.value = data.color;
                    textBgColorInput.value = data.backgroundColor;
                    toggleTextBg.checked = data.hasTextBackground;
                    const event = new Event('change');
                    toggleTextBg.dispatchEvent(event);
                    toggleTextOutline.checked = data.hasTextOutline;
                    textOutlineColorInput.value = data.outlineColor;
                    outlineThicknessRange.value = parseFloat(data.outlineThickness);
                    outlineThicknessValue.textContent = `${outlineThicknessRange.value}px`;
                    toggleTextOutline.dispatchEvent(event);
                    fontSizeRange.value = parseFloat(data.fontSize);
                    fontSizeValue.textContent = `${fontSizeRange.value}px`;

                    if (data.isBold) boldTextBtn.classList.add('active-style');
                    else boldTextBtn.classList.remove('active-style');

                    if (data.isItalic) italicTextBtn.classList.add('active-style');
                    else italicTextBtn.classList.remove('active-style');
                }
            }

            if (selectedElementWrapper && selectedElementWrapper.id === data.id) {
                selectElement(elementWrapper);
            }
        }

        function deleteElementFromData(elementId) {
            const elementWrapper = allElements.get(elementId);
            if (elementWrapper) {
                const contentElement = elementWrapper.querySelector('.element-content');
                if (contentElement && contentElement.tagName === 'AUDIO') {
                    contentElement.pause();
                    contentElement.src = '';
                    contentElement.load();
                }
                allElements.delete(elementId);
                elementWrapper.remove();
                if (selectedElementWrapper && selectedElementWrapper.id === elementId) {
                    deselectAllElements();
                }
            }
        }

        function updatePlayPauseButton(isPaused) {
            if (isPaused) {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            } else {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            }
        }

        function updateTimelineDisplay(audioElement) {
            if (!isNaN(audioElement.duration)) {
                timelineRange.max = audioElement.duration;
                timelineRange.value = audioElement.currentTime;
                currentTimeDisplay.textContent = `${formatTime(audioElement.currentTime)} / ${formatTime(audioElement.duration)}`;
            } else {
                currentTimeDisplay.textContent = `0:00 / 0:00`;
            }
        }

        function applyGlobalMuteState() {
            allElements.forEach(elementWrapper => {
                const audioElement = elementWrapper.querySelector('audio.element-content');
                if (audioElement) {
                    audioElement.muted = isMutedGlobally;
                }
            });

            if (selectedElementWrapper) {
                const selectedAudio = selectedElementWrapper.querySelector('audio.element-content');
                if (selectedAudio) {
                    volumeRange.value = selectedAudio.volume;
                    volumeValueDisplay.textContent = `${Math.round(selectedAudio.volume * 100)}%`;
                }
            }
            saveElementsState();
        }

        function deselectAllElements() {
            document.querySelectorAll('.element-wrapper').forEach(el => {
                el.classList.remove('selected');
                el.querySelectorAll('.resize-handle').forEach(handle => handle.style.display = 'none');
                el.querySelector('.rotation-handle').style.display = 'none';
            });
            document.querySelectorAll('.layer-item').forEach(item => item.classList.remove('selected'));

            selectedElementWrapper = null;

            opacityRange.value = 1;
            opacityValue.textContent = '100%';
            rotationRange.value = 0;
            rotationValue.textContent = '0°';
            opacityRange.disabled = true;
            rotationRange.disabled = true;
            duplicateElementBtn.disabled = true;
            deleteElementBtn.disabled = true;
            resetOpacityBtn.disabled = true;
            resetRotationBtn.disabled = true;
            bringToFrontBtn.disabled = true;

            textInput.disabled = false;
            textColorInput.value = '#FFFFFF';
            textBgColorInput.value = '#000000';
            toggleTextBg.checked = false;
            toggleTextOutline.checked = false;
            textOutlineColorInput.value = '#000000';
            outlineThicknessRange.value = 0;
            outlineThicknessValue.textContent = '0px';
            fontSizeRange.value = 24;
            fontSizeValue.textContent = '24px';
            boldTextBtn.classList.remove('active-style');
            italicTextBtn.classList.remove('active-style');
            textColorInput.disabled = false;
            boldTextBtn.disabled = false;
            italicTextBtn.disabled = false;
            toggleTextBg.disabled = false;
            toggleTextOutline.disabled = false;
            fontSizeRange.disabled = false;

            textBgColorInput.disabled = !toggleTextBg.checked;
            textOutlineColorInput.disabled = !toggleTextOutline.checked;
            outlineThicknessRange.disabled = !toggleTextOutline.checked;
            textBgColorLabel.classList.add('text-gray-600');
            textBgColorLabel.classList.remove('text-gray-300');
            textOutlineColorLabel.classList.add('text-gray-600');
            textOutlineColorLabel.classList.remove('text-gray-300');
            outlineThicknessLabel.classList.add('text-gray-600');
            outlineThicknessLabel.classList.remove('text-gray-300');

            playPauseBtn.disabled = true;
            volumeRange.disabled = true;
            timelineRange.disabled = true;
            currentAudioNameDisplay.textContent = '';
        }

        function selectElement(elementWrapper) {
            deselectAllElements();

            selectedElementWrapper = elementWrapper;
            selectedElementWrapper.classList.add('selected');

            const contentElement = selectedElementWrapper.querySelector('img.element-content, audio.element-content, div.text-content.element-content');
            if (!contentElement) {
                console.error("Could not find content element for selected wrapper:", selectedElementWrapper.id);
                return;
            }

            if (contentElement.tagName !== 'AUDIO') {
                selectedElementWrapper.querySelector('.rotation-handle').style.display = 'block';
                rotationRange.disabled = false;
            } else {
                selectedElementWrapper.querySelector('.rotation-handle').style.display = 'none';
                rotationRange.disabled = true;
            }

            if (!contentElement.classList.contains('text-content') && contentElement.tagName !== 'AUDIO') {
                selectedElementWrapper.querySelectorAll('.resize-handle').forEach(handle => handle.style.display = 'block');
            } else {
                selectedElementWrapper.querySelectorAll('.resize-handle').forEach(handle => handle.style.display = 'none');
            }

            opacityRange.disabled = false;
            duplicateElementBtn.disabled = false;
            deleteElementBtn.disabled = false;
            resetOpacityBtn.disabled = false;
            resetRotationBtn.disabled = false;
            bringToFrontBtn.disabled = false;

            opacityRange.value = parseFloat(contentElement.style.opacity) || 1;
            opacityValue.textContent = `${Math.round(opacityRange.value * 100)}%`;
            rotationRange.value = getRotation(selectedElementWrapper) || 0;
            rotationValue.textContent = `${Math.round(rotationRange.value)}°`;

            if (contentElement.classList.contains('text-content')) {
                textInput.disabled = false;
                textInput.value = contentElement.textContent;
                textColorInput.disabled = false;
                boldTextBtn.disabled = false;
                italicTextBtn.disabled = false;
                toggleTextBg.disabled = false;
                toggleTextOutline.disabled = false;
                fontSizeRange.disabled = false;

                textColorInput.value = contentElement.style.color || '#FFFFFF';

                if (contentElement.style.backgroundColor === 'transparent') {
                    toggleTextBg.checked = false;
                    textBgColorInput.value = '#000000';
                    textBgColorInput.disabled = true;
                    textBgColorLabel.classList.add('text-gray-600');
                    textBgColorLabel.classList.remove('text-gray-300');
                } else {
                    toggleTextBg.checked = true;
                    textBgColorInput.value = contentElement.style.backgroundColor || '#000000';
                    textBgColorInput.disabled = false;
                    textBgColorLabel.classList.remove('text-gray-600');
                    textBgColorLabel.classList.add('text-gray-300');
                }

                if (contentElement.style.webkitTextStrokeWidth && parseFloat(contentElement.style.webkitTextStrokeWidth) > 0) {
                    toggleTextOutline.checked = true;
                    textOutlineColorInput.value = contentElement.style.webkitTextStrokeColor || '#000000';
                    outlineThicknessRange.value = parseFloat(contentElement.style.webkitTextStrokeWidth);
                    outlineThicknessValue.textContent = `${outlineThicknessRange.value}px`;
                    textOutlineColorInput.disabled = false;
                    outlineThicknessRange.disabled = false;
                    textOutlineColorLabel.classList.remove('text-gray-600');
                    textOutlineColorLabel.classList.add('text-gray-300');
                    outlineThicknessLabel.classList.remove('text-gray-600');
                    outlineThicknessLabel.classList.add('text-gray-300');
                } else {
                    toggleTextOutline.checked = false;
                    textOutlineColorInput.value = '#000000';
                    outlineThicknessRange.value = 0;
                    outlineThicknessValue.textContent = '0px';
                    textOutlineColorInput.disabled = true;
                    outlineThicknessRange.disabled = true;
                    textOutlineColorLabel.classList.add('text-gray-600');
                    textOutlineColorLabel.classList.remove('text-gray-300');
                    outlineThicknessLabel.classList.add('text-gray-600');
                    outlineThicknessLabel.classList.remove('text-gray-300');
                }

                fontSizeRange.value = parseFloat(contentElement.style.fontSize) || 24;
                fontSizeValue.textContent = `${fontSizeRange.value}px`;

                if (contentElement.classList.contains('font-bold')) {
                    boldTextBtn.classList.add('active-style');
                } else {
                    boldTextBtn.classList.remove('active-style');
                }
                if (contentElement.classList.contains('italic')) {
                    italicTextBtn.classList.add('active-style');
                } else {
                    italicTextBtn.classList.remove('active-style');
                }
                adjustTextElementWrapperSize(selectedElementWrapper);
            } else if (contentElement.tagName === 'IMG') {
                textInput.value = '';
                currentAudioNameDisplay.textContent = '';
            } else if (contentElement.tagName === 'AUDIO') {
                playPauseBtn.disabled = false;
                volumeRange.disabled = false;
                timelineRange.disabled = false;

                contentElement.muted = isMutedGlobally;
                volumeRange.value = contentElement.volume;
                volumeValueDisplay.textContent = `${Math.round(contentElement.volume * 100)}%`;
                updatePlayPauseButton(contentElement.paused);
                updateTimelineDisplay(contentElement);
                currentAudioNameDisplay.textContent = elementWrapper.dataset.originalName || 'Audio Seleccionado';
            }

            const layerItem = document.querySelector(`.layer-item[data-id="${elementWrapper.id}"]`);
            if (layerItem) {
                layerItem.classList.add('selected');
            }
        }

        function getRotation(element) {
            const transform = element.style.transform;
            const match = transform.match(/rotate\(([-?\d.]+)deg\)/);
            return match ? parseFloat(match[1]) : 0;
        }

        function addHandles(elementWrapper) {
            const handles = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
            handles.forEach(pos => {
                const handle = document.createElement('div');
                handle.classList.add('resize-handle', pos);
                handle.style.display = 'none';
                elementWrapper.appendChild(handle);
            });

            const rotationHandle = document.createElement('div');
            rotationHandle.classList.add('rotation-handle');
            rotationHandle.style.display = 'none';
            elementWrapper.appendChild(rotationHandle);
        }

        function updateLayersList() {
            layersList.innerHTML = '';

            if (allElements.size === 0) {
                layersList.innerHTML = '<p class="text-gray-400 text-sm">No hay elementos en la página.</p>';
                return;
            }

            const sortedElements = Array.from(allElements.values()).sort((a, b) => {
                return (parseFloat(b.style.zIndex || 0)) - (parseFloat(a.style.zIndex || 0));
            });

            sortedElements.forEach(elementWrapper => {
                const contentElement = elementWrapper.querySelector('img.element-content, audio.element-content, div.text-content.element-content');
                const layerItem = document.createElement('div');
                layerItem.classList.add('layer-item');
                layerItem.dataset.id = elementWrapper.id;

                let name;
                if (contentElement && contentElement.tagName === 'IMG') {
                    name = `Imagen: "${elementWrapper.dataset.originalName || contentElement.alt || elementWrapper.id}"`;
                } else if (contentElement && contentElement.classList.contains('text-content')) {
                    name = `Texto: "${contentElement.textContent.substring(0, 20)}${contentElement.textContent.length > 20 ? '...' : ''}"`;
                } else if (contentElement && contentElement.tagName === 'AUDIO') {
                    name = `Audio: "${elementWrapper.dataset.originalName || 'Audio'}"`;
                } else {
                    name = `Elemento desconocido: ${elementWrapper.id}`;
                }
                layerItem.textContent = name;

                if (selectedElementWrapper && selectedElementWrapper.id === elementWrapper.id) {
                    layerItem.classList.add('selected');
                }

                layerItem.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectElement(elementWrapper);
                });

                const dragHandle = document.createElement('span');
                dragHandle.innerHTML = '&#9776;';
                dragHandle.classList.add('drag-handle', 'mr-2', 'cursor-move', 'text-gray-400', 'hover:text-white');
                dragHandle.setAttribute('draggable', 'true');
                layerItem.prepend(dragHandle);

                layersList.appendChild(layerItem);
            });
        }

        function updateFileCountDisplay() {
            fileCountDisplay.textContent = `${allElements.size}/${fileLimit}`;
            if (allElements.size >= fileLimit) {
                imageUpload.disabled = true;
                imageUpload.parentElement.classList.add('opacity-50', 'cursor-not-allowed');
                imageUpload.parentElement.style.pointerEvents = 'none';
                selectFileButtonText.textContent = 'Límite alcanzado';
                imageUpload.parentElement.classList.remove('hover:bg-purple-700');
                dropArea.classList.add('opacity-50', 'cursor-not-allowed');
                dropArea.style.pointerEvents = 'none';
            } else {
                imageUpload.disabled = false;
                imageUpload.parentElement.classList.remove('opacity-50', 'cursor-not-allowed');
                imageUpload.parentElement.style.pointerEvents = 'auto';
                selectFileButtonText.textContent = 'Seleccionar archivo';
                imageUpload.parentElement.classList.add('hover:bg-purple-700');
                dropArea.classList.remove('opacity-50', 'cursor-not-allowed');
                dropArea.style.pointerEvents = 'auto';
            }
        }

        function handleFile(file) {
            if (allElements.size >= fileLimit) {
                console.warn(`Se ha alcanzado el límite de carga de archivos (${fileLimit} archivos).`);
                return;
            }

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (file.type.startsWith('audio/')) {
                        const tempAudio = new Audio();
                        tempAudio.src = e.target.result;
                        tempAudio.addEventListener('loadedmetadata', () => {
                            if (tempAudio.duration > 480) {
                                console.warn(`El archivo de audio "${file.name}" excede el límite de 8 minutos (${formatTime(tempAudio.duration)}). No se añadirá.`);
                                return;
                            }
                            createAndAddElement(file, e.target.result, tempAudio.duration);
                        }, { once: true });
                        tempAudio.addEventListener('error', (err) => {
                            console.error('Error al cargar metadatos de audio:', err);
                        }, { once: true });
                    } else {
                        createAndAddElement(file, e.target.result);
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function createAndAddElement(file, srcData, audioDuration = null) {
            const wrapperDiv = document.createElement('div');
            wrapperDiv.id = generateUniqueId();
            wrapperDiv.classList.add('element-wrapper');

            const greenCanvasCenterX = leftSidebar.offsetWidth / 2;
            const greenCanvasCenterY = leftSidebar.offsetHeight / 2;
            const initialWrapperWidth = 100;
            const initialWrapperHeight = 100;
            const initialLeft = greenCanvasCenterX - (initialWrapperWidth / 2);
            const initialTop = greenCanvasCenterY - (initialWrapperHeight / 2);

            wrapperDiv.style.left = `${initialLeft}px`;
            wrapperDiv.style.top = `${initialTop}px`;
            wrapperDiv.style.minWidth = '50px';
            wrapperDiv.style.minHeight = '30px';
            wrapperDiv.style.zIndex = getNextHighestZIndex();
            wrapperDiv.style.transform = 'rotate(0deg)';
            wrapperDiv.dataset.originalName = file.name;

            let elementState = {
                id: wrapperDiv.id,
                left: wrapperDiv.style.left,
                top: wrapperDiv.style.top,
                width: wrapperDiv.style.width,
                height: wrapperDiv.style.height,
                rotation: wrapperDiv.style.transform,
                zIndex: wrapperDiv.style.zIndex,
                opacity: '1',
                originalName: file.name
            };

            let contentElement;
            if (file.type.startsWith('image/')) {
                contentElement = document.createElement('img');
                contentElement.src = srcData;
                contentElement.alt = file.name;
                wrapperDiv.style.width = '100px';
                wrapperDiv.style.height = 'auto';
                contentElement.classList.add('element-content');
                wrapperDiv.appendChild(contentElement);
                contentElement.style.opacity = '1';

                contentElement.onload = () => {
                    wrapperDiv.style.height = `${contentElement.offsetHeight}px`;
                    const updatedElementState = {
                        ...elementState,
                        width: wrapperDiv.style.width,
                        height: wrapperDiv.style.height
                    };
                    sendWebSocketMessage('elementUpdate', { element: updatedElementState });
                };
                elementState.type = 'img';
                elementState.src = srcData;
            } else if (file.type.startsWith('audio/')) {
                contentElement = document.createElement('audio');
                contentElement.src = srcData;
                contentElement.volume = 0.5;
                contentElement.dataset.lastVolume = 0.5;
                contentElement.muted = isMutedGlobally;
                contentElement.classList.add('hidden');
                contentElement.classList.add('element-content');
                wrapperDiv.style.width = '50px';
                wrapperDiv.style.height = '50px';

                const audioIcon = document.createElement('div');
                audioIcon.classList.add('audio-visual-icon', 'flex', 'items-center', 'justify-center', 'text-gray-400', 'text-2xl', 'h-full', 'w-full');
                audioIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
                        <path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 10v4h3l4 4V6l-4 4H5z"/>
                    </svg>
                `;
                wrapperDiv.appendChild(audioIcon);
                wrapperDiv.appendChild(contentElement);
                contentElement.style.opacity = '1';

                contentElement.addEventListener('timeupdate', () => {
                    if (selectedElementWrapper && selectedElementWrapper.id === wrapperDiv.id) {
                        updateTimelineDisplay(contentElement);
                    }
                });
                contentElement.addEventListener('ended', () => {
                    if (selectedElementWrapper && selectedElementWrapper.id === wrapperDiv.id) {
                        updatePlayPauseButton(true);
                        contentElement.currentTime = 0;
                        timelineRange.value = 0;
                        currentTimeDisplay.textContent = formatTime(0) + ' / ' + formatTime(contentElement.duration || 0);
                    }
                });

                if (audioDuration !== null) {
                    contentElement.duration = audioDuration;
                    updateTimelineDisplay(contentElement);
                } else {
                    contentElement.addEventListener('loadedmetadata', () => {
                        updateTimelineDisplay(contentElement);
                        const updatedElementState = {
                            ...elementState,
                            duration: contentElement.duration
                        };
                        sendWebSocketMessage('elementUpdate', { element: updatedElementState });
                    }, { once: true });
                }

                elementState.type = 'audio';
                elementState.src = srcData;
                elementState.volume = contentElement.volume;
                elementState.currentTime = contentElement.currentTime;
                elementState.paused = contentElement.paused;
                elementState.isPlaying = !contentElement.paused;
                elementState.duration = contentElement.duration || audioDuration;
                elementState.lastVolume = contentElement.dataset.lastVolume;
            }
            addHandles(wrapperDiv);
            mainCanvasWrapper.appendChild(wrapperDiv);
            allElements.set(wrapperDiv.id, wrapperDiv);
            updateLayersList();
            updateFileCountDisplay();
            sendWebSocketMessage('elementAdd', { element: elementState });
        }

        imageUpload.addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                handleFile(event.target.files[0]);
                event.target.value = '';
            }
        });

        addTextBtn.addEventListener('click', () => {
            if (allElements.size >= fileLimit) {
                console.warn(`Se ha alcanzado el límite de carga de archivos (${fileLimit} archivos).`);
                return;
            }

            const textContent = textInput.value.trim() === '' ? 'Nuevo Texto' : textInput.value;
            const wrapperDiv = document.createElement('div');
            wrapperDiv.id = generateUniqueId();
            wrapperDiv.classList.add('element-wrapper', 'text-element-wrapper');

            const greenCanvasCenterX = leftSidebar.offsetWidth / 2;
            const greenCanvasCenterY = leftSidebar.offsetHeight / 2;
            const initialLeft = greenCanvasCenterX - (100 / 2);
            const initialTop = greenCanvasCenterY - (50 / 2);

            wrapperDiv.style.left = `${initialLeft}px`;
            wrapperDiv.style.top = `${initialTop}px`;
            wrapperDiv.style.minWidth = '50px';
            wrapperDiv.style.minHeight = '30px';
            wrapperDiv.style.zIndex = getNextHighestZIndex();
            wrapperDiv.style.transform = 'rotate(0deg)';
            wrapperDiv.style.width = 'auto';
            wrapperDiv.style.height = 'auto';
            wrapperDiv.dataset.originalName = 'Text Element';

            const textDiv = document.createElement('div');
            textDiv.classList.add('element-content', 'text-content', 'text-lg');
            textDiv.contentEditable = true;
            textDiv.textContent = textContent;
            textDiv.style.opacity = '1';
            textDiv.spellcheck = false;

            textDiv.style.color = textColorInput.value;
            textDiv.style.webkitTextFillColor = textColorInput.value;
            textDiv.style.fontSize = `${fontSizeRange.value}px`;

            if (toggleTextBg.checked) {
                textDiv.style.backgroundColor = textBgColorInput.value;
            } else {
                textDiv.style.backgroundColor = 'transparent';
            }

            if (toggleTextOutline.checked) {
                const thickness = outlineThicknessRange.value;
                const color = textOutlineColorInput.value;
                textDiv.style.webkitTextStrokeWidth = `${thickness}px`;
                textDiv.style.webkitTextStrokeColor = color;
                textDiv.style.textShadow = generateTextShadowForOutline(thickness, color);
            } else {
                textDiv.style.webkitTextStrokeWidth = '0';
                textDiv.style.webkitTextStrokeColor = 'transparent';
                textDiv.style.textShadow = 'none';
            }

            if (boldTextBtn.classList.contains('active-style')) {
                textDiv.classList.add('font-bold');
            }
            if (italicTextBtn.classList.contains('active-style')) {
                textDiv.classList.add('italic');
            }

            wrapperDiv.appendChild(textDiv);
            addHandles(wrapperDiv);
            mainCanvasWrapper.appendChild(wrapperDiv);
            allElements.set(wrapperDiv.id, wrapperDiv);
            adjustTextElementWrapperSize(wrapperDiv);
            textDiv.focus();

            updateLayersList();
            updateFileCountDisplay();

            const elementState = {
                id: wrapperDiv.id,
                left: wrapperDiv.style.left,
                top: wrapperDiv.style.top,
                width: wrapperDiv.style.width,
                height: wrapperDiv.style.height,
                rotation: wrapperDiv.style.transform,
                zIndex: wrapperDiv.style.zIndex,
                opacity: textDiv.style.opacity,
                originalName: wrapperDiv.dataset.originalName,
                type: 'text',
                textContent: textDiv.textContent,
                color: textDiv.style.color,
                backgroundColor: textDiv.style.backgroundColor,
                fontSize: textDiv.style.fontSize,
                isBold: textDiv.classList.contains('font-bold'),
                isItalic: textDiv.classList.contains('italic'),
                outlineThickness: textDiv.style.webkitTextStrokeWidth,
                outlineColor: textDiv.style.webkitTextStrokeColor,
                hasTextBackground: (textDiv.style.backgroundColor !== 'transparent'),
                hasTextOutline: (parseFloat(textDiv.style.webkitTextStrokeWidth) > 0)
            };
            sendWebSocketMessage('elementAdd', { element: elementState });
        });

        textInput.addEventListener('input', () => {
            if (selectedElementWrapper) {
                const contentElement = selectedElementWrapper.querySelector('.element-content');
                if (contentElement && contentElement.classList.contains('text-content')) {
                    contentElement.textContent = textInput.value;
                    adjustTextElementWrapperSize(selectedElementWrapper);
                    updateLayersList();

                    // Envío de actualización con requestAnimationFrame
                    if (!pendingUpdateAnimationFrame) {
                        pendingUpdateAnimationFrame = requestAnimationFrame(() => {
                            const elementState = {
                                id: selectedElementWrapper.id,
                                textContent: contentElement.textContent,
                                width: selectedElementWrapper.style.width,
                                height: selectedElementWrapper.style.height
                            };
                            sendWebSocketMessage('elementUpdate', { element: { ...getElementState(selectedElementWrapper), ...elementState } });
                            pendingUpdateAnimationFrame = null;
                        });
                    }
                }
            }
        });

        function getElementState(elementWrapper) {
            const contentElement = elementWrapper.querySelector('img.element-content, audio.element-content, div.text-content.element-content');
            if (!contentElement) return null;

            const state = {
                id: elementWrapper.id,
                left: elementWrapper.style.left,
                top: elementWrapper.style.top,
                width: elementWrapper.style.width,
                height: elementWrapper.style.height,
                rotation: elementWrapper.style.transform,
                zIndex: elementWrapper.style.zIndex,
                opacity: contentElement.style.opacity,
                originalName: elementWrapper.dataset.originalName || ''
            };

            if (contentElement.tagName === 'IMG') {
                state.type = contentElement.tagName.toLowerCase();
                state.src = contentElement.src;
            } else if (contentElement.tagName === 'AUDIO') {
                state.type = contentElement.tagName.toLowerCase();
                state.src = contentElement.src;
                state.volume = contentElement.volume;
                state.currentTime = contentElement.currentTime;
                state.paused = contentElement.paused;
                state.isPlaying = !contentElement.paused;
                state.duration = contentElement.duration;
                state.lastVolume = contentElement.dataset.lastVolume;
            } else if (contentElement.classList.contains('text-content')) {
                state.type = 'text';
                state.textContent = contentElement.textContent;
                state.color = contentElement.style.color;
                state.backgroundColor = contentElement.style.backgroundColor;
                state.fontSize = contentElement.style.fontSize;
                state.isBold = contentElement.classList.contains('font-bold');
                state.isItalic = contentElement.classList.contains('italic');
                state.outlineThickness = contentElement.style.webkitTextStrokeWidth;
                state.outlineColor = contentElement.style.webkitTextStrokeColor;
                state.hasTextBackground = (contentElement.style.backgroundColor !== 'transparent');
                state.hasTextOutline = (parseFloat(contentElement.style.webkitTextStrokeWidth) > 0);
            }
            return state;
        }

        opacityRange.addEventListener('input', () => {
            if (selectedElementWrapper) {
                const contentElement = selectedElementWrapper.querySelector('.element-content');
                if (contentElement) {
                    contentElement.style.opacity = opacityRange.value;
                    opacityValue.textContent = `${Math.round(opacityRange.value * 100)}%`;
                    if (!pendingUpdateAnimationFrame) {
                        pendingUpdateAnimationFrame = requestAnimationFrame(() => {
                            sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                            pendingUpdateAnimationFrame = null;
                        });
                    }
                }
            }
        });

        rotationRange.addEventListener('input', () => {
            if (selectedElementWrapper) {
                selectedElementWrapper.style.transform = `rotate(${rotationRange.value}deg)`;
                rotationValue.textContent = `${Math.round(rotationRange.value)}°`;
                 if (!pendingUpdateAnimationFrame) {
                    pendingUpdateAnimationFrame = requestAnimationFrame(() => {
                        sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                        pendingUpdateAnimationFrame = null;
                    });
                }
            }
        });

        duplicateElementBtn.addEventListener('click', () => {
            if (allElements.size >= fileLimit) {
                console.warn(`Se ha alcanzado el límite de carga de archivos (${fileLimit} archivos).`);
                return;
            }
            if (selectedElementWrapper) {
                const originalContentElement = selectedElementWrapper.querySelector('.element-content');
                const clonedWrapper = selectedElementWrapper.cloneNode(true);
                const newId = generateUniqueId();
                clonedWrapper.id = newId;
                clonedWrapper.style.left = `${parseFloat(selectedElementWrapper.style.left) + 20}px`;
                clonedWrapper.style.top = `${parseFloat(selectedElementWrapper.style.top) + 20}px`;
                clonedWrapper.style.zIndex = getNextHighestZIndex();
                clonedWrapper.querySelectorAll('.resize-handle').forEach(handle => handle.style.display = 'none');
                clonedWrapper.querySelector('.rotation-handle').style.display = 'none';

                if (originalContentElement.tagName === 'AUDIO') {
                    const clonedAudioElement = clonedWrapper.querySelector('audio.element-content');
                    if (clonedAudioElement) {
                        clonedAudioElement.pause();
                        clonedAudioElement.currentTime = 0;
                        clonedAudioElement.muted = isMutedGlobally;
                        clonedAudioElement.dataset.lastVolume = originalContentElement.dataset.lastVolume || 0.5;
                        clonedAudioElement.addEventListener('timeupdate', () => {
                            if (selectedElementWrapper && selectedElementWrapper.id === clonedWrapper.id) {
                                updateTimelineDisplay(clonedAudioElement);
                            }
                        });
                        clonedAudioElement.addEventListener('ended', () => {
                            if (selectedElementWrapper && selectedElementWrapper.id === clonedWrapper.id) {
                                updatePlayPauseButton(true);
                                clonedAudioElement.currentTime = 0;
                                timelineRange.value = 0;
                                currentTimeDisplay.textContent = formatTime(0) + ' / ' + formatTime(clonedAudioElement.duration || 0);
                            }
                        });
                        clonedAudioElement.addEventListener('loadedmetadata', () => {
                            updateTimelineDisplay(clonedAudioElement);
                            if (!originalContentElement.paused && !isMutedGlobally) {
                                clonedAudioElement.play().catch(e => {
                                    console.warn('Autoplay blocked for cloned audio:', e);
                                });
                            }
                        });
                    }
                }
                if (originalContentElement.classList.contains('text-content')) {
                    const clonedTextElement = clonedWrapper.querySelector('.text-content.element-content');
                    if (clonedTextElement) {
                        clonedTextElement.contentEditable = true;
                        adjustTextElementWrapperSize(clonedWrapper);
                    }
                }

                mainCanvasWrapper.appendChild(clonedWrapper);
                allElements.set(newId, clonedWrapper);
                selectElement(clonedWrapper);
                updateLayersList();
                updateFileCountDisplay();
                sendWebSocketMessage('elementAdd', { element: getElementState(clonedWrapper) });
            }
        });

        deleteElementBtn.addEventListener('click', () => {
            if (selectedElementWrapper) {
                const contentElement = selectedElementWrapper.querySelector('.element-content');
                if (contentElement && contentElement.tagName === 'AUDIO') {
                    contentElement.pause();
                    contentElement.src = '';
                    contentElement.load();
                }
                const deletedId = selectedElementWrapper.id;
                allElements.delete(selectedElementWrapper.id);
                selectedElementWrapper.remove();
                deselectAllElements();
                updateLayersList();
                updateFileCountDisplay();
                sendWebSocketMessage('elementDelete', { elementId: deletedId });
            }
        });

        textColorInput.addEventListener('input', () => {
            if (selectedElementWrapper) {
                const contentElement = selectedElementWrapper.querySelector('.element-content');
                if (contentElement && contentElement.classList.contains('text-content')) {
                    contentElement.style.color = textColorInput.value;
                    contentElement.style.webkitTextFillColor = textColorInput.value;
                    if (toggleTextOutline.checked) {
                        contentElement.style.textShadow = generateTextShadowForOutline(outlineThicknessRange.value, textOutlineColorInput.value);
                    }
                    adjustTextElementWrapperSize(selectedElementWrapper);
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            }
        });

        textBgColorInput.addEventListener('input', () => {
            if (selectedElementWrapper) {
                const contentElement = selectedElementWrapper.querySelector('.element-content');
                if (contentElement && contentElement.classList.contains('text-content')) {
                    contentElement.style.backgroundColor = textBgColorInput.value;
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            }
        });

        boldTextBtn.addEventListener('click', () => {
            if (selectedElementWrapper) {
                const contentElement = selectedElementWrapper.querySelector('.element-content');
                if (contentElement && contentElement.classList.contains('text-content')) {
                    contentElement.classList.toggle('font-bold');
                    adjustTextElementWrapperSize(selectedElementWrapper);
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            }
            boldTextBtn.classList.toggle('active-style');
        });

        italicTextBtn.addEventListener('click', () => {
            if (selectedElementWrapper) {
                const contentElement = selectedElementWrapper.querySelector('.element-content');
                if (contentElement && contentElement.classList.contains('text-content')) {
                    contentElement.classList.toggle('italic');
                    adjustTextElementWrapperSize(selectedElementWrapper);
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            }
            italicTextBtn.classList.toggle('active-style');
        });

        toggleTextBg.addEventListener('change', () => {
            if (selectedElementWrapper) {
                const textElement = selectedElementWrapper.querySelector('.element-content');
                if (textElement && textElement.classList.contains('text-content')) {
                    if (toggleTextBg.checked) {
                        textElement.style.backgroundColor = textBgColorInput.value;
                        textBgColorInput.disabled = false;
                        textBgColorLabel.classList.remove('text-gray-600');
                        textBgColorLabel.classList.add('text-gray-300');
                    } else {
                        textElement.style.backgroundColor = 'transparent';
                        textBgColorInput.disabled = true;
                        textBgColorLabel.classList.add('text-gray-600');
                        textBgColorLabel.classList.remove('text-gray-300');
                    }
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            } else {
                 textBgColorInput.disabled = !toggleTextBg.checked;
                 if (toggleTextBg.checked) {
                     textBgColorLabel.classList.remove('text-gray-600');
                     textBgColorLabel.classList.add('text-gray-300');
                 } else {
                     textBgColorLabel.classList.add('text-gray-600');
                     textBgColorLabel.classList.remove('text-gray-300');
                 }
            }
        });

        toggleTextOutline.addEventListener('change', () => {
            if (selectedElementWrapper) {
                const textElement = selectedElementWrapper.querySelector('.element-content');
                if (textElement && textElement.classList.contains('text-content')) {
                    if (toggleTextOutline.checked) {
                        const thickness = outlineThicknessRange.value;
                        const color = textOutlineColorInput.value;
                        textElement.style.webkitTextStrokeWidth = `${thickness}px`;
                        textElement.style.webkitTextStrokeColor = color;
                        textElement.style.textShadow = generateTextShadowForOutline(thickness, color);
                        textOutlineColorInput.disabled = false;
                        outlineThicknessRange.disabled = false;
                        textOutlineColorLabel.classList.remove('text-gray-600');
                        textOutlineColorLabel.classList.add('text-gray-300');
                        outlineThicknessLabel.classList.remove('text-gray-600');
                        outlineThicknessLabel.classList.add('text-gray-300');
                    } else {
                        textElement.style.webkitTextStrokeWidth = '0';
                        textElement.style.webkitTextStrokeColor = 'transparent';
                        textElement.style.textShadow = 'none';
                        textOutlineColorInput.disabled = true;
                        outlineThicknessRange.disabled = true;
                        textOutlineColorLabel.classList.add('text-gray-600');
                        textOutlineColorLabel.classList.remove('text-gray-300');
                        outlineThicknessLabel.classList.add('text-gray-600');
                        outlineThicknessLabel.classList.remove('text-gray-300');
                    }
                    adjustTextElementWrapperSize(selectedElementWrapper);
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            } else {
                textOutlineColorInput.disabled = !toggleTextOutline.checked;
                outlineThicknessRange.disabled = !toggleTextOutline.checked;
                if (toggleTextOutline.checked) {
                    textOutlineColorLabel.classList.remove('text-gray-600');
                    textOutlineColorLabel.classList.add('text-gray-300');
                    outlineThicknessLabel.classList.remove('text-gray-600');
                    outlineThicknessLabel.classList.add('text-gray-300');
                } else {
                    textOutlineColorLabel.classList.add('text-gray-600');
                    textOutlineColorLabel.classList.remove('text-gray-300');
                    outlineThicknessLabel.classList.add('text-gray-600');
                    outlineThicknessLabel.classList.remove('text-gray-300');
                }
            }
        });

        textOutlineColorInput.addEventListener('input', () => {
            if (selectedElementWrapper) {
                const contentElement = selectedElementWrapper.querySelector('.element-content');
                if (contentElement && contentElement.classList.contains('text-content') && toggleTextOutline.checked) {
                    contentElement.style.webkitTextStrokeColor = textOutlineColorInput.value;
                    contentElement.style.textShadow = generateTextShadowForOutline(outlineThicknessRange.value, textOutlineColorInput.value);
                    adjustTextElementWrapperSize(selectedElementWrapper);
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            }
        });

        outlineThicknessRange.addEventListener('input', () => {
            if (selectedElementWrapper) {
                const contentElement = selectedElementWrapper.querySelector('.element-content');
                if (contentElement && contentElement.classList.contains('text-content') && toggleTextOutline.checked) {
                    const thickness = outlineThicknessRange.value;
                    const color = textOutlineColorInput.value;
                    contentElement.style.webkitTextStrokeWidth = `${thickness}px`;
                    contentElement.style.webkitTextStrokeColor = color;
                    contentElement.style.textShadow = generateTextShadowForOutline(thickness, color);
                    outlineThicknessValue.textContent = `${thickness}px`;
                    adjustTextElementWrapperSize(selectedElementWrapper);
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            } else {
                outlineThicknessValue.textContent = `${outlineThicknessRange.value}px`;
            }
        });

        fontSizeRange.addEventListener('input', () => {
            if (selectedElementWrapper) {
                const contentElement = selectedElementWrapper.querySelector('.element-content');
                if (contentElement && contentElement.classList.contains('text-content')) {
                    contentElement.style.fontSize = `${fontSizeRange.value}px`;
                    adjustTextElementWrapperSize(selectedElementWrapper);
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            }
            fontSizeValue.textContent = `${fontSizeRange.value}px`;
        });

        resetOpacityBtn.addEventListener('click', () => {
            if (selectedElementWrapper) {
                const contentElement = selectedElementWrapper.querySelector('.element-content');
                if (contentElement) {
                    contentElement.style.opacity = '1';
                    opacityRange.value = 1;
                    opacityValue.textContent = '100%';
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            }
        });

        resetRotationBtn.addEventListener('click', () => {
            if (selectedElementWrapper) {
                selectedElementWrapper.style.transform = 'rotate(0deg)';
                rotationRange.value = 0;
                rotationValue.textContent = '0°';
                sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
            }
        });

        playPauseBtn.addEventListener('click', () => {
            if (selectedElementWrapper) {
                const audioElement = selectedElementWrapper.querySelector('audio.element-content');
                if (audioElement) {
                    if (audioElement.paused) {
                        allElements.forEach(element => {
                            const otherAudio = element.querySelector('audio.element-content');
                            if (otherAudio && otherAudio !== audioElement && !otherAudio.paused) {
                                otherAudio.pause();
                                sendWebSocketMessage('elementUpdate', { element: getElementState(element) });
                            }
                        });
                        audioElement.play().catch(e => {
                            console.error('Error al reproducir el audio (posible restricción de auto-reproducción del navegador):', e);
                        });
                    } else {
                        audioElement.pause();
                    }
                    updatePlayPauseButton(audioElement.paused);
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            }
        });

        volumeRange.addEventListener('input', () => {
            if (selectedElementWrapper) {
                const audioElement = selectedElementWrapper.querySelector('audio.element-content');
                if (audioElement) {
                    audioElement.volume = parseFloat(volumeRange.value);
                    audioElement.dataset.lastVolume = volumeRange.value;
                    
                    if (parseFloat(volumeRange.value) === 0) {
                        audioElement.muted = true;
                    } else {
                        audioElement.muted = isMutedGlobally;
                    }
                    volumeValueDisplay.textContent = `${Math.round(volumeRange.value * 100)}%`;
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            }
        });

        timelineRange.addEventListener('input', () => {
            if (selectedElementWrapper) {
                const audioElement = selectedElementWrapper.querySelector('audio.element-content');
                if (audioElement) {
                    audioElement.currentTime = timelineRange.value;
                    updateTimelineDisplay(audioElement);
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            }
        });

        bringToFrontBtn.addEventListener('click', () => {
            if (selectedElementWrapper) {
                selectedElementWrapper.style.zIndex = getNextHighestZIndex();
                updateLayersList();
                selectElement(selectedElementWrapper);
                sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                sendWebSocketMessage('reorderLayers', { elements: Array.from(allElements.values()).map(el => ({ id: el.id, zIndex: el.style.zIndex })) });
            }
        });

        document.addEventListener('mousedown', (e) => {
            const target = e.target;
            const clickedWrapper = target.closest('.element-wrapper');
            const wrapperRect = mainCanvasWrapper.getBoundingClientRect();
            const mouseXOnUnscaledWrapper = (e.clientX - wrapperRect.left) / currentZoom;
            const mouseYOnUnscaledWrapper = (e.clientY - wrapperRect.top) / currentZoom;

            if (clickedWrapper) {
                e.stopPropagation();

                if (target.classList.contains('resize-handle')) {
                    e.preventDefault();
                    isResizing = true;
                    selectedElementWrapper = clickedWrapper;
                    selectElement(selectedElementWrapper);
                    activeHandle = Array.from(target.classList).find(cls => cls.startsWith('top-') || cls.startsWith('bottom-'));
                    initialMouseX = mouseXOnUnscaledWrapper;
                    initialMouseY = mouseYOnUnscaledWrapper;
                    initialLeft = selectedElementWrapper.offsetLeft;
                    initialTop = selectedElementWrapper.offsetTop;
                    initialWidth = selectedElementWrapper.offsetWidth;
                    initialHeight = selectedElementWrapper.offsetHeight;
                    return;
                }

                if (target.classList.contains('rotation-handle')) {
                    const contentElement = clickedWrapper.querySelector('.element-content');
                    if (contentElement && contentElement.tagName === 'AUDIO') {
                        return;
                    }

                    e.preventDefault();
                    isRotating = true;
                    selectedElementWrapper = clickedWrapper;
                    selectElement(selectedElementWrapper);
                    const rect = selectedElementWrapper.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    initialRotationAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
                    initialElementRotation = getRotation(selectedElementWrapper);
                    return;
                }

                e.preventDefault();
                isDragging = true;
                selectElement(clickedWrapper);
                initialMouseX = mouseXOnUnscaledWrapper;
                initialMouseY = mouseYOnUnscaledWrapper;
                initialLeft = selectedElementWrapper.offsetLeft;
                initialTop = selectedElementWrapper.offsetTop;
            } else {
                if (!target.closest('aside') && !target.closest('.zoom-controls') && !target.closest('.modal')) {
                    deselectAllElements();
                }
            }
        });

        document.addEventListener('mousemove', (e) => {
            const wrapperRect = mainCanvasWrapper.getBoundingClientRect();
            const currentMouseXOnUnscaledWrapper = (e.clientX - wrapperRect.left) / currentZoom;
            const currentMouseYOnUnscaledWrapper = (e.clientY - wrapperRect.top) / currentZoom;

            if (isDragging && selectedElementWrapper) {
                e.preventDefault();
                const dx = currentMouseXOnUnscaledWrapper - initialMouseX;
                const dy = currentMouseYOnUnscaledWrapper - initialMouseY;

                let newLeft = initialLeft + dx;
                let newTop = initialTop + dy;

                selectedElementWrapper.style.left = `${newLeft}px`;
                selectedElementWrapper.style.top = `${newTop}px`;

                // Uso de requestAnimationFrame para enviar actualizaciones
                if (!pendingUpdateAnimationFrame) {
                    pendingUpdateAnimationFrame = requestAnimationFrame(() => {
                        sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                        pendingUpdateAnimationFrame = null;
                    });
                }
            } else if (isResizing && selectedElementWrapper) {
                e.preventDefault();
                const dx = currentMouseXOnUnscaledWrapper - initialMouseX;
                const dy = currentMouseYOnUnscaledWrapper - initialMouseY;

                let newWidth = initialWidth;
                let newHeight = initialHeight;
                let newLeft = initialLeft;
                let newTop = initialTop;

                switch (activeHandle) {
                    case 'top-left':
                        newWidth = initialWidth - dx;
                        newHeight = initialHeight - dy;
                        newLeft = initialLeft + dx;
                        newTop = initialTop + dy;
                        break;
                    case 'top-right':
                        newWidth = initialWidth + dx;
                        newHeight = initialHeight - dy;
                        newTop = initialTop + dy;
                        break;
                    case 'bottom-left':
                        newWidth = initialWidth - dx;
                        newHeight = initialHeight + dy;
                        newLeft = initialLeft + dx;
                        break;
                    case 'bottom-right':
                        newWidth = initialWidth + dx;
                        newHeight = initialHeight + dy;
                        break;
                }

                const contentElement = selectedElementWrapper.querySelector('.element-content');
                if (contentElement && (contentElement.tagName === 'IMG')) {
                    const originalAspectRatio = initialWidth / initialHeight;
                    let newHeightFromWidth = newWidth / originalAspectRatio;
                    if (Math.abs(newHeightFromWidth - (initialHeight + dy)) > Math.abs(newWidth - (initialWidth + dx))) {
                            newWidth = newHeight * originalAspectRatio;
                        }
                    newHeight = newHeightFromWidth;
                    if (activeHandle.startsWith('top-') && newHeight !== initialHeight) {
                            newTop = initialTop + (initialHeight - newHeight);
                        }
                    if (activeHandle.endsWith('-left') && newWidth !== initialWidth) {
                            newLeft = initialLeft + (initialWidth - newWidth);
                        }

                } else if (contentElement && contentElement.classList.contains('text-content')) {
                    const textElement = contentElement;
                    const tempDiv = document.createElement('div');
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.visibility = 'hidden';
                    tempDiv.style.whiteSpace = 'pre-wrap';
                    tempDiv.style.wordBreak = 'break-word';
                    tempDiv.style.boxSizing = 'border-box';
                    tempDiv.style.fontSize = window.getComputedStyle(textElement).fontSize;
                    tempDiv.style.fontWeight = window.getComputedStyle(textElement).fontWeight;
                    tempDiv.style.fontStyle = window.getComputedStyle(textElement).fontStyle;
                    tempDiv.style.fontFamily = window.getComputedStyle(textElement).fontFamily;
                    tempDiv.style.lineHeight = '1';
                    tempDiv.style.textAlign = 'center';
                    tempDiv.style.display = 'flex';
                    tempDiv.style.alignItems = 'center';
                    tempDiv.style.justifyContent = 'center';

                    const outlineThickness = parseFloat(textElement.style.webkitTextStrokeWidth) || 0;
                    const outlineColor = textElement.style.webkitTextStrokeColor || '#000000';
                    if (outlineThickness > 0) {
                        tempDiv.style.webkitTextStrokeWidth = `${outlineThickness}px`;
                        tempDiv.style.webkitTextStrokeColor = outlineColor;
                        tempDiv.style.textShadow = generateTextShadowForOutline(outlineThickness, outlineColor);
                    } else {
                        tempDiv.style.webkitTextStrokeWidth = '0';
                        tempDiv.style.webkitTextStrokeColor = 'transparent';
                        tempDiv.style.textShadow = 'none';
                    }

                    tempDiv.textContent = textElement.textContent;
                    document.body.appendChild(tempDiv);

                    const rawTextRect = tempDiv.getBoundingClientRect();
                    const minContentWidth = rawTextRect.width;
                    const minContentHeight = rawTextRect.height;
                    document.body.removeChild(tempDiv);

                    const wrapperPaddingHorizontal = 25;
                    const wrapperPaddingVertical = 10;
                    const clampedWidth = Math.max(newWidth, minContentWidth + (wrapperPaddingHorizontal * 2));
                    const clampedHeight = Math.max(newHeight, minContentHeight + (wrapperPaddingVertical * 2));

                    const widthDiff = clampedWidth - newWidth;
                    const heightDiff = clampedHeight - newHeight;
                    if (activeHandle.startsWith('top-')) {
                        newTop -= heightDiff;
                    }
                    if (activeHandle.endsWith('-left')) {
                        newLeft -= widthDiff;
                    }
                    newWidth = clampedWidth;
                    newHeight = clampedHeight;
                }

                newWidth = Math.max(20, newWidth);
                newHeight = Math.max(20, newHeight);

                selectedElementWrapper.style.width = `${newWidth}px`;
                selectedElementWrapper.style.height = `${newHeight}px`;
                selectedElementWrapper.style.left = `${newLeft}px`;
                selectedElementWrapper.style.top = `${newTop}px`;

                initialMouseX = currentMouseXOnUnscaledWrapper;
                initialMouseY = currentMouseYOnUnscaledWrapper;
                initialWidth = newWidth;
                initialHeight = newHeight;
                initialLeft = newLeft;
                initialTop = newTop;

                // Uso de requestAnimationFrame para enviar actualizaciones
                if (!pendingUpdateAnimationFrame) {
                    pendingUpdateAnimationFrame = requestAnimationFrame(() => {
                        sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                        pendingUpdateAnimationFrame = null;
                    });
                }
            } else if (isRotating && selectedElementWrapper) {
                e.preventDefault();
                const rect = selectedElementWrapper.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const currentAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
                const angleDiff = (currentAngle - initialRotationAngle) * 180 / Math.PI;
                let newRotation = initialElementRotation + angleDiff;
                newRotation = (newRotation % 360 + 360) % 360;

                selectedElementWrapper.style.transform = `rotate(${newRotation}deg)`;
                rotationRange.value = newRotation;
                rotationValue.textContent = `${Math.round(newRotation)}°`;

                // Uso de requestAnimationFrame para enviar actualizaciones
                if (!pendingUpdateAnimationFrame) {
                    pendingUpdateAnimationFrame = requestAnimationFrame(() => {
                        sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                        pendingUpdateAnimationFrame = null;
                    });
                }
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDragging || isResizing || isRotating) {
                if (pendingUpdateAnimationFrame) {
                    cancelAnimationFrame(pendingUpdateAnimationFrame);
                    pendingUpdateAnimationFrame = null;
                }
                if (selectedElementWrapper) {
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            }
            isDragging = false;
            isResizing = false;
            isRotating = false;
            activeHandle = '';
        });

        document.addEventListener('touchstart', (e) => {
            const target = e.target;
            const clickedWrapper = target.closest('.element-wrapper');
            const wrapperRect = mainCanvasWrapper.getBoundingClientRect();
            const touchXOnUnscaledWrapper = (e.touches[0].clientX - wrapperRect.left) / currentZoom;
            const touchYOnUnscaledWrapper = (e.touches[0].clientY - wrapperRect.top) / currentZoom;

            if (e.touches.length === 1) {
                if (clickedWrapper) {
                    if (target.classList.contains('resize-handle')) {
                        e.preventDefault();
                        isResizing = true;
                        selectedElementWrapper = clickedWrapper;
                        selectElement(selectedElementWrapper);
                        activeHandle = Array.from(target.classList).find(cls => cls.startsWith('top-') || cls.startsWith('bottom-'));
                        initialMouseX = touchXOnUnscaledWrapper;
                        initialMouseY = touchYOnUnscaledWrapper;
                        initialLeft = selectedElementWrapper.offsetLeft;
                        initialTop = selectedElementWrapper.offsetTop;
                        initialWidth = selectedElementWrapper.offsetWidth;
                        initialHeight = selectedElementWrapper.offsetHeight;
                        return;
                    }

                    if (target.classList.contains('rotation-handle')) {
                        const contentElement = clickedWrapper.querySelector('.element-content');
                        if (contentElement && contentElement.tagName === 'AUDIO') {
                            return;
                        }

                        e.preventDefault();
                        isRotating = true;
                        selectedElementWrapper = clickedWrapper;
                        selectElement(selectedElementWrapper);
                        const rect = selectedElementWrapper.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;
                        initialRotationAngle = Math.atan2(e.touches[0].clientY - centerY, e.touches[0].clientX - centerX);
                        initialElementRotation = getRotation(selectedElementWrapper);
                        return;
                    }

                    e.preventDefault();
                    isDragging = true;
                    selectElement(clickedWrapper);
                    initialMouseX = touchXOnUnscaledWrapper;
                    initialMouseY = touchYOnUnscaledWrapper;
                    initialLeft = clickedWrapper.offsetLeft;
                    initialTop = clickedWrapper.offsetTop;
                } else {
                    if (!target.closest('aside') && !target.closest('.zoom-controls') && !target.closest('.modal')) {
                        deselectAllElements();
                    }
                }
            }
        });

        document.addEventListener('touchmove', (e) => {
            const wrapperRect = mainCanvasWrapper.getBoundingClientRect();
            const currentTouchXOnUnscaledWrapper = (e.touches[0].clientX - wrapperRect.left) / currentZoom;
            const currentTouchYOnUnscaledWrapper = (e.touches[0].clientY - wrapperRect.top) / currentZoom;

            if (e.touches.length === 1) {
                if (isDragging && selectedElementWrapper) {
                    e.preventDefault();
                    const dx = currentTouchXOnUnscaledWrapper - initialMouseX;
                    const dy = currentTouchYOnUnscaledWrapper - initialMouseY;

                    let newLeft = initialLeft + dx;
                    let newTop = initialTop + dy;

                    selectedElementWrapper.style.left = `${newLeft}px`;
                    selectedElementWrapper.style.top = `${newTop}px`;

                    if (!pendingUpdateAnimationFrame) {
                        pendingUpdateAnimationFrame = requestAnimationFrame(() => {
                            sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                            pendingUpdateAnimationFrame = null;
                        });
                    }
                } else if (isResizing && selectedElementWrapper) {
                    e.preventDefault();
                    const dx = currentTouchXOnUnscaledWrapper - initialMouseX;
                    const dy = currentTouchYOnUnscaledWrapper - initialMouseY;

                    let newWidth = initialWidth;
                    let newHeight = initialHeight;
                    let newLeft = initialLeft;
                    let newTop = initialTop;

                    switch (activeHandle) {
                        case 'top-left':
                            newWidth = initialWidth - dx;
                            newHeight = initialHeight - dy;
                            newLeft = initialLeft + dx;
                            newTop = initialTop + dy;
                            break;
                        case 'top-right':
                            newWidth = initialWidth + dx;
                            newHeight = initialHeight - dy;
                            newTop = initialTop + dy;
                            break;
                        case 'bottom-left':
                            newWidth = initialWidth - dx;
                            newHeight = initialHeight + dy;
                            newLeft = initialLeft + dx;
                            break;
                        case 'bottom-right':
                            newWidth = initialWidth + dx;
                            newHeight = initialHeight + dy;
                            break;
                    }

                    const contentElement = selectedElementWrapper.querySelector('.element-content');
                    if (contentElement && (contentElement.tagName === 'IMG')) {
                        const originalAspectRatio = initialWidth / initialHeight;
                        let newHeightFromWidth = newWidth / originalAspectRatio;
                        if (Math.abs(newHeightFromWidth - (initialHeight + dy)) > Math.abs(newWidth - (initialWidth + dx))) {
                                newWidth = newHeight * originalAspectRatio;
                            }
                        newHeight = newHeightFromWidth;
                        if (activeHandle.startsWith('top-') && newHeight !== initialHeight) {
                                newTop = initialTop + (initialHeight - newHeight);
                            }
                        if (activeHandle.endsWith('-left') && newWidth !== initialWidth) {
                                newLeft = initialLeft + (initialWidth - newWidth);
                            }
                    } else if (contentElement && contentElement.classList.contains('text-content')) {
                        const textElement = contentElement;
                        const tempDiv = document.createElement('div');
                        tempDiv.style.position = 'absolute';
                        tempDiv.style.visibility = 'hidden';
                        tempDiv.style.whiteSpace = 'pre-wrap';
                        tempDiv.style.wordBreak = 'break-word';
                        tempDiv.style.boxSizing = 'border-box';
                        tempDiv.style.fontSize = window.getComputedStyle(textElement).fontSize;
                        tempDiv.style.fontWeight = window.getComputedStyle(textElement).fontWeight;
                        tempDiv.style.fontStyle = window.getComputedStyle(textElement).fontStyle;
                        tempDiv.style.fontFamily = window.getComputedStyle(textElement).fontFamily;
                        tempDiv.style.lineHeight = '1';
                        tempDiv.style.textAlign = 'center';
                        tempDiv.style.display = 'flex';
                        tempDiv.style.alignItems = 'center';
                        tempDiv.style.justifyContent = 'center';

                        const outlineThickness = parseFloat(textElement.style.webkitTextStrokeWidth) || 0;
                        const outlineColor = textElement.style.webkitTextStrokeColor || '#000000';
                        if (outlineThickness > 0) {
                            tempDiv.style.webkitTextStrokeWidth = `${outlineThickness}px`;
                            tempDiv.style.webkitTextStrokeColor = outlineColor;
                            tempDiv.style.textShadow = generateTextShadowForOutline(outlineThickness, outlineColor);
                        } else {
                            tempDiv.style.webkitTextStrokeWidth = '0';
                            tempDiv.style.webkitTextStrokeColor = 'transparent';
                            tempDiv.style.textShadow = 'none';
                        }

                        tempDiv.textContent = textElement.textContent;
                        document.body.appendChild(tempDiv);
                        const rawTextRect = tempDiv.getBoundingClientRect();
                        const minContentWidth = rawTextRect.width;
                        const minContentHeight = rawTextRect.height;
                        document.body.removeChild(tempDiv);

                        const wrapperPaddingHorizontal = 25;
                        const wrapperPaddingVertical = 10;
                        const clampedWidth = Math.max(newWidth, minContentWidth + (wrapperPaddingHorizontal * 2));
                        const clampedHeight = Math.max(newHeight, minContentHeight + (wrapperPaddingVertical * 2));

                        const widthDiff = clampedWidth - newWidth;
                        const heightDiff = clampedHeight - newHeight;
                        if (activeHandle.startsWith('top-')) {
                            newTop -= heightDiff;
                        }
                        if (activeHandle.endsWith('-left')) {
                            newLeft -= widthDiff;
                        }
                        newWidth = clampedWidth;
                        newHeight = clampedHeight;
                    }

                    newWidth = Math.max(20, newWidth);
                    newHeight = Math.max(20, newHeight);

                    selectedElementWrapper.style.width = `${newWidth}px`;
                    selectedElementWrapper.style.height = `${newHeight}px`;
                    selectedElementWrapper.style.left = `${newLeft}px`;
                    selectedElementWrapper.style.top = `${newTop}px`;

                    initialMouseX = currentTouchXOnUnscaledWrapper;
                    initialMouseY = currentTouchYOnUnscaledWrapper;
                    initialWidth = newWidth;
                    initialHeight = newHeight;
                    initialLeft = newLeft;
                    initialTop = newTop;

                    if (!pendingUpdateAnimationFrame) {
                        pendingUpdateAnimationFrame = requestAnimationFrame(() => {
                            sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                            pendingUpdateAnimationFrame = null;
                        });
                    }
                } else if (isRotating && selectedElementWrapper) {
                    e.preventDefault();
                    const rect = selectedElementWrapper.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;

                    const currentAngle = Math.atan2(e.touches[0].clientY - centerY, e.touches[0].clientX - centerX);
                    const angleDiff = (currentAngle - initialRotationAngle) * 180 / Math.PI;
                    let newRotation = initialElementRotation + angleDiff;
                    newRotation = (newRotation % 360 + 360) % 360;

                    selectedElementWrapper.style.transform = `rotate(${newRotation}deg)`;
                    rotationRange.value = newRotation;
                    rotationValue.textContent = `${Math.round(newRotation)}°`;

                    if (!pendingUpdateAnimationFrame) {
                        pendingUpdateAnimationFrame = requestAnimationFrame(() => {
                            sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                            pendingUpdateAnimationFrame = null;
                        });
                    }
                }
            }
        });

        document.addEventListener('touchend', () => {
            if (isDragging || isResizing || isRotating) {
                if (pendingUpdateAnimationFrame) {
                    cancelAnimationFrame(pendingUpdateAnimationFrame);
                    pendingUpdateAnimationFrame = null;
                }
                if (selectedElementWrapper) {
                    sendWebSocketMessage('elementUpdate', { element: getElementState(selectedElementWrapper) });
                }
            }
            isDragging = false;
            isResizing = false;
            isRotating = false;
            activeHandle = '';
        });

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(`tab-content-${tabId}`).classList.add('active');
            });
        });

        let draggedLayer = null;
        layersList.addEventListener('dragstart', (e) => {
            const target = e.target.closest('.layer-item');
            if (target) {
                draggedLayer = target;
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => {
                    target.style.opacity = '0.5';
                }, 0);
            }
        });

        layersList.addEventListener('dragover', (e) => {
            e.preventDefault();
            const target = e.target.closest('.layer-item');
            if (target && target !== draggedLayer) {
                const bounding = target.getBoundingClientRect();
                const offset = bounding.y + (bounding.height / 2);
                if (e.clientY < offset) {
                    layersList.insertBefore(draggedLayer, target);
                } else {
                    layersList.insertBefore(draggedLayer, target.nextSibling);
                }
            }
        });

        layersList.addEventListener('dragend', () => {
            if (draggedLayer) {
                draggedLayer.style.opacity = '1';
                draggedLayer = null;

                let maxZ = getNextHighestZIndex() - 1;
                if (maxZ < 100) {
                    maxZ = 100;
                }

                const layersInNewOrder = Array.from(layersList.children);
                const updatedElementsForReorder = [];
                layersInNewOrder.forEach((layerItem, index) => {
                    if (layerItem.dataset.id) {
                        const elementWrapper = allElements.get(layerItem.dataset.id);
                        if (elementWrapper) {
                            const newZIndex = maxZ - index;
                            elementWrapper.style.zIndex = newZIndex;
                            updatedElementsForReorder.push({ id: elementWrapper.id, zIndex: newZIndex });
                        }
                    }
                });

                updateLayersList();
                sendWebSocketMessage('reorderLayers', { elements: updatedElementsForReorder });
            }
        });

        zoomRange.addEventListener('input', () => {
            currentZoom = parseFloat(zoomRange.value);
            applyZoom();
        });

        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('highlight');
            e.dataTransfer.dropEffect = 'copy';
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('highlight');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('highlight');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
            loadElementsState();
            mainCanvasWrapper.style.transformOrigin = 'center center';
            deselectAllElements();
            updateLayersList();
            updateFileCountDisplay();
            applyZoom();
            showMutePreferenceModal();
        });

        function showMutePreferenceModal() {
            mutePreferenceModal.classList.add('active');

            modalMuteBtn.onclick = () => {
                isMutedGlobally = true;
                applyGlobalMuteState();
                mutePreferenceModal.classList.remove('active');
            };

            modalSoundBtn.onclick = () => {
                isMutedGlobally = false;
                applyGlobalMuteState();
                mutePreferenceModal.classList.remove('active');
            };
        }
    </script>
</body>
</html>
